name: Swift Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-swift-package:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Run Swift Package tests
      run: |
        swift test --enable-code-coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: swift-package
        name: swift-package-coverage
      continue-on-error: true

  test-xcode-project:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Generate Xcode project
      run: |
        if ! command -v xcodegen &> /dev/null; then
          brew install xcodegen
        fi
        xcodegen generate
    
    - name: Run Xcode tests
      run: |
        xcodebuild test \
          -scheme CozyBrewApp \
          -destination 'platform=macOS' \
          -enableCodeCoverage YES \
          -quiet
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: xcode-project
        name: xcode-project-coverage
      continue-on-error: true

  build-release:
    runs-on: macos-latest
    needs: [test-swift-package, test-xcode-project]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Generate Xcode project
      run: |
        if ! command -v xcodegen &> /dev/null; then
          brew install xcodegen
        fi
        xcodegen generate
    
    - name: Build Release
      run: |
        xcodebuild build \
          -scheme CozyBrewApp \
          -configuration Release \
          -destination 'platform=macOS' \
          -quiet
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: cozy-brew-build
        path: build/Release/CozyBrewApp.app
      continue-on-error: true
